{% extends "base.html" %}
{% load i18n %}
{% block title %}Dashboard Â· Expense Tracker{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
  <div>
    <div class="page-title">{% trans "Dashboard" %}</div>
    <div class="page-subtitle">
      {% trans "Overview of your spending patterns." %}
    </div>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a href="{% url 'expenses:expense_add' %}" class="btn btn-primary btn-sm">
      {% trans "+ Add expense" %}
    </a>
    <a href="{% url 'expenses:expense_list' %}" class="btn btn-outline-secondary btn-sm">
      {% trans "View all" %}
    </a>
  </div>
</div>

{% if not has_expenses %}
<div class="alert alert-modern mb-4">
  <h4 class="mb-1">Welcome, {{ user.username }} ðŸ‘‹</h4>
  <p class="mb-2">
    {% trans "You don't have any expenses yet. Start by adding your first one or setting up categories." %}
  </p>
  <div class="d-flex flex-wrap gap-2">
    <a href="{% url 'expenses:expense_add' %}" class="btn btn-primary btn-sm">
      {% trans "Add first expense" %}
    </a>
    <a href="{% url 'expenses:category_list' %}" class="btn btn-outline-secondary btn-sm">
      {% trans "Manage categories" %}
    </a>
  </div>
</div>
{% endif %}

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <div class="card card-glass p-3 h-100">
      <div class="d-flex justify-content-between align-items-center card-glass-header">
        <div class="metric-label">{% trans "Total spent" %}</div>
        <span class="badge-soft">{% trans "All time" %}</span>
      </div>
      <div class="metric-value">
        {{ total_all|floatformat:2 }} {{ USER_CURRENCY_SYMBOL }}
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card card-glass p-3 h-100">
      <div class="d-flex justify-content-between align-items-center card-glass-header">
        <div class="metric-label">{% trans "This month" %}</div>
      </div>
      <div class="metric-value">
        {{ total_this_month|floatformat:2 }} {{ USER_CURRENCY_SYMBOL }}
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-lg-5">
    <div class="card card-glass p-3 h-100">
      <div class="card-glass-header d-flex justify-content-between align-items-center">
        <span class="metric-label">{% trans 'Top categories' %}</span>
        <span class="badge-soft">{% trans "This month" %}</span>
      </div>
      <div class="table-responsive">
        <table class="table table-modern align-middle mb-0">
          <thead>
          <tr>
            <th>{% trans "Category" %}</th>
            <th class="text-end">{% trans "Total" %}</th>
          </tr>
          </thead>
          <tbody>
          {% for row in by_category %}
            <tr>
              <td>{{ row.category__name|default:"(No category)" }}</td>
              <td class="text-end">
                {{ row.total|floatformat:2 }} {{ USER_CURRENCY_SYMBOL }}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2" class="text-center">
                {% trans "No expenses yet." %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-7">
    <div class="card card-glass p-3 h-100">
      <div class="card-glass-header d-flex justify-content-between align-items-center">
        <span class="metric-label">{% trans "By category" %}</span>
        <span class="badge-soft">{% trans "Last" %} {{ by_category|length }} {% trans "categories" %}</span>
      </div>
      <canvas id="categoryChart" style="max-height: 260px;"></canvas>
    </div>
  </div>
</div>

<div class="card card-glass p-3">
  <div class="card-glass-header d-flex justify-content-between align-items-center">
    <span class="metric-label">{% trans "By month" %}</span>
    <span class="badge-soft">{% trans "Trend" %}</span>
  </div>
  <canvas id="monthlyChart" style="max-height: 280px;"></canvas>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const categoryLabels = {{ category_labels_json|safe }};
  const categoryTotals = {{ category_totals_json|safe }};
  const monthlyLabels = {{ monthly_labels_json|safe }};
  const monthlyTotals = {{ monthly_totals_json|safe }};
  const currencySymbol = "{{ USER_CURRENCY_SYMBOL|escapejs }}";

  // Category pie chart
  const ctxCategory = document.getElementById('categoryChart');
  if (ctxCategory && categoryLabels.length > 0) {
    new Chart(ctxCategory, {
      type: 'pie',
      data: {
        labels: categoryLabels,
        datasets: [{
          label: 'Expenses by category',
          data: categoryTotals
        }]
      },
      options: {
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = Number(context.parsed) || 0;
                return `${label}: ${value.toFixed(2)} ${currencySymbol}`;
              }
            }
          }
        }
      }
    });
  }


  // Monthly bar chart
  const ctxMonthly = document.getElementById('monthlyChart');
  if (ctxMonthly && monthlyLabels.length > 0) {
    new Chart(ctxMonthly, {
      type: 'bar',
      data: {
        labels: monthlyLabels,
        datasets: [{
          label: `Expenses by month (${currencySymbol})`,
          data: monthlyTotals
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                const num = Number(value) || 0;
                return num.toFixed(2) + ' ' + currencySymbol;
              }
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = Number(context.parsed.y) || 0;
                return `${context.label}: ${value.toFixed(2)} ${currencySymbol}`;
              }
            }
          },
          legend:{
            display: false
          }
        }
      }
    });
  }
</script>

{% endblock %}
