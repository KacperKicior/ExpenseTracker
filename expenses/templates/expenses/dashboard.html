{% extends "base.html" %}
{% block content %}
<h1>Dashboard</h1>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5>Total (all time)</h5>
        <p class="fs-3">{{ total_all|floatformat:2 }} {{ USER_CURRENCY_SYMBOL }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5>Total (this month)</h5>
        <p class="fs-3">{{ total_this_month|floatformat:2 }} {{ USER_CURRENCY_SYMBOL }}</p>
      </div>
    </div>
  </div>
</div>

<h3>Top categories</h3>
<table class="table table-striped mb-4">
  <thead>
    <tr>
      <th>Category</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    {% for row in by_category %}
    <tr>
      <td>{{ row.category__name|default:"(No category)" }}</td>
      <td>{{ row.total|floatformat:2 }} {{ USER_CURRENCY_SYMBOL }}</td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="2">No expenses yet.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="row">
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-body">
        <h5>Expenses by category</h5>
        <canvas id="categoryChart"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-body">
        <h5>Expenses by month</h5>
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  const categoryLabels = {{ category_labels_json|safe }};
  const categoryTotals = {{ category_totals_json|safe }};
  const monthlyLabels = {{ monthly_labels_json|safe }};
  const monthlyTotals = {{ monthly_totals_json|safe }};
  const currencySymbol = "{{ USER_CURRENCY_SYMBOL|escapejs }}";

  // Category pie chart
  const ctxCategory = document.getElementById('categoryChart');
  if (ctxCategory && categoryLabels.length > 0) {
    new Chart(ctxCategory, {
      type: 'pie',
      data: {
        labels: categoryLabels,
        datasets: [{
          label: 'Expenses by category',
          data: categoryTotals
        }]
      },
      options: {
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = Number(context.parsed) || 0;
                return `${label}: ${value.toFixed(2)} ${currencySymbol}`;
              }
            }
          }
        }
      }
    });
  }


  // Monthly bar chart
  const ctxMonthly = document.getElementById('monthlyChart');
  if (ctxMonthly && monthlyLabels.length > 0) {
    new Chart(ctxMonthly, {
      type: 'bar',
      data: {
        labels: monthlyLabels,
        datasets: [{
          label: `Expenses by month (${currencySymbol})`,
          data: monthlyTotals
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                const num = Number(value) || 0;
                return num.toFixed(2) + ' ' + currencySymbol;
              }
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = Number(context.parsed.y) || 0;
                return `${context.label}: ${value.toFixed(2)} ${currencySymbol}`;
              }
            }
          },
          legend:{
            display: false
          }
        }
      }
    });
  }
</script>

{% endblock %}
